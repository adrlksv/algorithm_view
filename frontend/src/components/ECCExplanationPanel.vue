<template>
  <div class="p-6 rounded-xl shadow-lg bg-gray-800 border border-gray-700 transition-all duration-300">
    <h2 class="text-2xl font-bold mb-4 text-green-400">Пояснения к шагам ECC</h2>
    
    <div v-if="currentExplanation" class="space-y-4">
      <h3 class="text-xl font-semibold text-green-300">{{ currentExplanation.title }}</h3>
      <div class="text-gray-300 space-y-2">
        <p v-for="(paragraph, idx) in currentExplanation.content" :key="idx">{{ paragraph }}</p>
      </div>
      
      <div v-if="currentExplanation.formula" class="mt-3 p-3 bg-gray-700 rounded-lg">
        <div class="font-mono text-sm text-green-400 mb-1">Формула:</div>
        <div class="font-mono text-sm">{{ currentExplanation.formula }}</div>
      </div>
      
      <div v-if="currentExplanation.note" class="mt-2 p-2 bg-gray-900 rounded text-sm text-gray-400">
        {{ currentExplanation.note }}
      </div>

      <div v-if="currentExplanation.curves" class="mt-3 p-3 bg-gray-700 rounded-lg">
        <h4 class="font-medium text-green-300 mb-2">Для кривой {{ curveName }}:</h4>
        <p class="text-gray-300 text-sm">{{ currentExplanation.curves[curveName] }}</p>
      </div>
    </div>
    
    <div v-else class="text-gray-400 italic">
      Выберите шаг алгоритма для просмотра пояснений
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue';

const props = defineProps({
  stepName: String,
  curveName: {
    type: String,
    default: 'secp256r1'
  }
});

const explanations = {
  '1. Выбор эллиптической кривой': {
    title: '1. Выбор эллиптической кривой',
    content: [
      'Эллиптическая кривая - это алгебраическая кривая, определяемая уравнением:',
      'y² = x³ + ax + b mod p',
      'Где:',
      '- a, b - коэффициенты кривой',
      '- p - простое число, определяющее конечное поле GF(p)',
      '',
      'Кривые стандартизированы организациями:',
      '- NIST (США): P-256, P-384, P-521',
      '- Brainpool (Европа): brainpoolP256r1 и др.',
      '- SECG: secp256k1 (используется в Bitcoin)',
      '',
      'Кривые различаются:',
      '- Размером (битовая длина p)',
      '- Уравнением',
      '- Базовой точкой'
    ],
    formula: 'y² = x³ + ax + b mod p',
    curves: {
      'secp256r1': 'NIST P-256 (secp256r1): 256-битная кривая, p ≈ 2²⁵⁶, широко используется в TLS, SSH',
      'secp384r1': 'NIST P-384 (secp384r1): 384-битная, p ≈ 2³⁸⁴, повышенная безопасность',
      'secp521r1': 'NIST P-521 (secp521r1): 521-битная, p ≈ 2⁵²¹, максимальная безопасность'
    }
  },
  '2. Выбор базовой точки G': {
    title: '2. Базовая точка G',
    content: [
      'Базовая точка G (генератор) - это точка на кривой, которая порождает циклическую подгруппу:',
      '{ G, 2G, 3G, ..., nG = O }',
      'Где:',
      '- n - порядок подгруппы (простое число)',
      '- O - нейтральный элемент (точка на бесконечности)',
      '',
      'Свойства:',
      '- n×G = O (умножение точки на порядок дает нейтральный элемент)',
      '- Для любого 1 ≤ k < n, k×G ≠ O',
      '- Все точки k×G различны для 1 ≤ k < n',
      '',
      'Безопасность:',
      'n должно быть большим простым числом (≥2²⁵⁶)',
      'Кофактор h = #E(F_p)/n должен быть маленьким (обычно 1)'
    ],
    formula: 'n×G = O (точка на бесконечности)',
    note: 'Параметры G и n публикуются в стандартах кривой'
  },
  '3. Генерация закрытого ключа d': {
    title: '3. Закрытый ключ d',
    content: [
      'Закрытый ключ d - это случайное целое число в диапазоне [1, n-1]',
      'Где n - порядок подгруппы, порожденной точкой G',
      '',
      'Требования к закрытому ключу:',
      '- Должен быть действительно случайным',
      '- Не должен повторяться',
      '- Должен храниться в секрете',
      '',
      'Генерация:',
      'Используются криптографически стойкие генераторы случайных чисел (CSPRNG)',
      'Для secp256r1: 256 бит случайных данных',
      'Для secp384r1: 384 бит случайных данных',
      'Для secp521r1: 521 бит случайных данных'
    ],
    formula: 'd ∈ [1, n-1]',
    note: 'Компрометация закрытого ключа приводит к полному взлому системы'
  },
  '4.1 Начало умножения точки': {
    title: '4.1 Начало умножения точки',
    content: [
      'Открытый ключ вычисляется как Q = d×G',
      'Где:',
      '- d - закрытый ключ',
      '- G - базовая точка',
      '',
      'Алгоритм double-and-add:',
      '1. Инициализация: Q = O (точка на бесконечности)',
      '2. Для каждого бита d (начиная со старшего):',
      '   a. Удвоение: Q = 2×Q',
      '   b. Если бит = 1: Q = Q + G',
      '3. Результат: Q = d×G',
      '',
      'Операции выполняются по модулю p'
    ],
    formula: 'Q = d×G',
    note: 'Алгоритм аналогичен возведению в степень по модулю'
  },
  '4. Открытый ключ вычислен': {
    title: '4. Открытый ключ вычислен',
    content: [
      'Открытый ключ Q - это точка на эллиптической кривой',
      'Вычисляется как Q = d×G',
      '',
      'Свойства:',
      '- Зная d и G, легко вычислить Q',
      '- Зная Q и G, вычислить d - сложная задача (ECDLP)',
      '- Может свободно распространяться',
      '',
      'Форматы хранения:',
      '- Сжатый: только x-координата + бит четности y',
      '- Несжатый: обе координаты (x, y)',
      '- PEM, DER, JWK'
    ],
    formula: 'Q = (x, y) = d×G',
    note: 'Открытый ключ используется для проверки подписей и шифрования'
  },
  '5. Формирование ключевой пары': {
    title: '5. Формирование ключевой пары',
    content: [
      'Ключевая пара ECC состоит из:',
      '- Закрытого ключа d (секретное число)',
      '- Открытого ключа Q (точка на кривой)',
      '',
      'Применение:',
      '- Цифровые подписи (ECDSA)',
      '- Шифрование (ECIES)',
      '- Обмен ключами (ECDH)',
      '',
      'Безопасность:',
      'Основана на сложности задачи дискретного логарифмирования на эллиптической кривой (ECDLP)',
      'Для взлома требуется решить ECDLP: найти d по известным Q и G'
    ],
    curves: {
      'secp256r1': 'Размер закрытого ключа: 256 бит, открытого: 257 бит (сжатый) или 520 бит (несжатый)',
      'secp384r1': 'Размер закрытого ключа: 384 бит, открытого: 385 бит (сжатый) или 776 бит (несжатый)',
      'secp521r1': 'Размер закрытого ключа: 521 бит, открытого: 522 бит (сжатый) или 1042 бит (несжатый)'
    },
    note: 'Рекомендуется использовать кривые с длиной не менее 256 бит'
  }
};

const currentExplanation = computed(() => {
  if (!props.stepName) return null;
  
  // Ищем полное совпадение
  if (explanations[props.stepName]) {
    return explanations[props.stepName];
  }
  
  // Ищем частичное совпадение
  for (const [key, value] of Object.entries(explanations)) {
    if (props.stepName.includes(key)) {
      return value;
    }
  }
  
  // Возвращаем общее описание, если не нашли
  return {
    title: props.stepName,
    content: ['Подробное описание этого шага будет добавлено в будущих версиях.']
  };
});
</script>